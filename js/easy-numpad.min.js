(function($){
    $.fn.focusTextToEnd = function(){
        this.focus();
        var $thisVal = this.val();
        this.val('').val($thisVal);
        return this;
    }
}(jQuery));

$(document).ready(function () {
    $(document).on('click', '.numberpicker',function(){
        last_focused_easy_numpad = $(this);
        show_easy_numpad();
    });
});

var last_focused_easy_numpad = null;

function show_easy_numpad() {
    var easy_numpad = `
        <div class="easy-numpad-frame" id="easy-numpad-frame">
            <div class="easy-numpad-container">
                <div class="easy-numpad-output-container">
                    <input type="number" class="easy-numpad-output" id="easy-numpad-output" value="`+last_focused_easy_numpad.val()+`"/>
                </div>
                <div class="easy-numpad-number-container">
                    <table>
                        <tr>
                            <td><a href="7" onclick="easynum()" class="btn btn-default">7</a></td>
                            <td><a href="8" onclick="easynum()" class="btn btn-default">8</a></td>
                            <td><a href="9" onclick="easynum()" class="btn btn-default">9</a></td>
                            <td><a href="Del" class="del btn btn-info" id="del" onclick="easy_numpad_del()">`+_t(82)+`</a></td>
                        </tr>
                        <tr>
                            <td><a href="4" onclick="easynum()" class="btn btn-default">4</a></td>
                            <td><a href="5" onclick="easynum()" class="btn btn-default">5</a></td>
                            <td><a href="6" onclick="easynum()" class="btn btn-default">6</a></td>
                            <td><a href="Clear" class="clear btn btn-warning" id="clear" onclick="easy_numpad_clear()">`+_t(84)+`</a></td>
                        </tr>
                        <tr>
                            <td><a href="1" onclick="easynum()" class="btn btn-default">1</a></td>
                            <td><a href="2" onclick="easynum()" class="btn btn-default">2</a></td>
                            <td><a href="3" onclick="easynum()" class="btn btn-default">3</a></td>
                            <td><a href="Cancel" class="cancel btn btn-danger" id="cancel" onclick="easy_numpad_cancel()">`+_t(76)+`</a></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td><a onclick="easynum()" href="0" class="btn btn-default">0</a></td>
                            <td></td>
                            <td><a href="Done" class="done btn btn-primary" id="done" onclick="easy_numpad_done()">`+_t(77)+`</a></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    `;
    $('body').append(easy_numpad);
    $("#easy-numpad-output").focusTextToEnd().keyup(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == 13){
            $("#done").click();
        }else if(keycode == 27){
            $("#cancel").click();
        }
    
    });
}

function easy_numpad_close() {
    if(last_focused_easy_numpad.attr("data-on-change")){
        window[last_focused_easy_numpad.attr("data-on-change")](last_focused_easy_numpad);
    }
    last_focused_easy_numpad = null;
    $('#easy-numpad-frame').remove();
}

function easynum() {
    event.preventDefault();

    navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
    if (navigator.vibrate) {
        navigator.vibrate(60);
    }

    var easy_num_button = $(event.target);
    var easy_num_value = easy_num_button.text();
    $('#easy-numpad-output').val( "" + $('#easy-numpad-output').val() + easy_num_value).focusTextToEnd();
}
function easy_numpad_del() {
    event.preventDefault();
    var easy_numpad_output_val = ""+$('#easy-numpad-output').val();
    var easy_numpad_output_val_deleted = easy_numpad_output_val.slice(0, -1);
    $('#easy-numpad-output').val(easy_numpad_output_val_deleted).focusTextToEnd();
}
function easy_numpad_clear() {
    event.preventDefault();
    $('#easy-numpad-output').val("").focus();
}
function easy_numpad_cancel() {
    event.preventDefault();
    $('#easy-numpad-frame').remove();
}
function easy_numpad_done() {
    event.preventDefault();
    var easy_numpad_output_val = $('#easy-numpad-output').val();
    easy_numpad_output_val = easy_numpad_output_val ? easy_numpad_output_val : 0;
    last_focused_easy_numpad.val(easy_numpad_output_val);
    easy_numpad_close();
}